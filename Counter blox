-- SHΔDØW CORE OPTIMIZED BUILD
-- CuTins Heck 2025 - ERROR FREE & STEALTH ENHANCED

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- STEALTH CONFIGURATION
local ShadowConfig = {
    ACTIVE = true,
    VERSION = "ShadowBuild_v2.4.1",
    
    AIMBOT = {
        ENABLED = false,
        FOV = 80,
        SMOOTHING = 0.3,
        TEAM_CHECK = true,
        PREDICTION = 0.15
    },
    
    ESP = {
        ENABLED = false,
        TEAM_CHECK = true,
        MAX_DISTANCE = 500,
        UPDATE_INTERVAL = 0.2
    },
    
    HITBOX = {
        ENABLED = false,
        SIZE = 2.0,
        TRANSPARENCY = 0.7
    },
    
    FLY = {
        ENABLED = false,
        SPEED = 3,
        VERTICAL_MULTIPLIER = 1.5
    }
}

-- SHADOW VARIABLES
local TARGET = nil
local ESP_CACHE = {}
local FLY_CONTROLS = {W=false, A=false, S=false, D=false, Space=false, Shift=false}
local LAST_ESP_UPDATE = 0
local BODYGYRO, BODYVELOCITY = nil, nil

-- MEMORY MANAGEMENT
local function SafeDestroy(obj)
    if obj and obj.Parent then
        obj:Destroy()
    end
end

local function CleanupOrphans()
    for player, highlight in pairs(ESP_CACHE) do
        if not player or not player.Parent or not player.Character then
            SafeDestroy(highlight)
            ESP_CACHE[player] = nil
        end
    end
end

-- STEALTH GUI CONSTRUCTION
local function CreateShadowGUI()
    if game:GetService("CoreGui"):FindFirstChild("ShadowInterface") then
        game:GetService("CoreGui").ShadowInterface:Destroy()
    end

    local GUI = Instance.new("ScreenGui")
    GUI.Name = "ShadowInterface"
    GUI.Parent = game:GetService("CoreGui")
    GUI.ResetOnSpawn = false

    local MainFrame = Instance.new("Frame")
    MainFrame.Size = UDim2.new(0, 320, 0, 450)
    MainFrame.Position = UDim2.new(0, 30, 0.5, -225)
    MainFrame.BackgroundColor3 = Color3.fromRGB(15, 15, 25)
    MainFrame.BorderColor3 = Color3.fromRGB(40, 40, 60)
    MainFrame.BorderSizePixel = 2
    MainFrame.Active = true
    MainFrame.Draggable = true
    MainFrame.Parent = GUI

    -- ENHANCED TITLE BAR
    local TitleBar = Instance.new("Frame")
    TitleBar.Size = UDim2.new(1, 0, 0, 35)
    TitleBar.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    TitleBar.BorderSizePixel = 0
    TitleBar.Parent = MainFrame

    local TitleGradient = Instance.new("UIGradient")
    TitleGradient.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 40, 40)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(180, 20, 20))
    })
    TitleGradient.Parent = TitleBar

    local TitleLabel = Instance.new("TextLabel")
    TitleLabel.Size = UDim2.new(1, -50, 1, 0)
    TitleLabel.BackgroundTransparency = 1
    TitleLabel.Text = "SHADOW CORE // v2.4.1"
    TitleLabel.TextColor3 = Color3.fromRGB(220, 220, 220)
    TitleLabel.TextSize = 14
    TitleLabel.Font = Enum.Font.GothamMedium
    TitleLabel.Parent = TitleBar

    local CloseButton = Instance.new("TextButton")
    CloseButton.Size = UDim2.new(0, 25, 0, 25)
    CloseButton.Position = UDim2.new(1, -30, 0, 5)
    CloseButton.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
    CloseButton.TextColor3 = Color3.fromRGB(200, 200, 200)
    CloseButton.Text = "×"
    CloseButton.TextSize = 16
    CloseButton.Font = Enum.Font.GothamBold
    CloseButton.Parent = TitleBar

    -- CONTENT FRAME WITH SCROLLING
    local ContentFrame = Instance.new("ScrollingFrame")
    ContentFrame.Size = UDim2.new(1, -15, 1, -50)
    ContentFrame.Position = UDim2.new(0, 7, 0, 40)
    ContentFrame.BackgroundTransparency = 1
    ContentFrame.ScrollBarThickness = 4
    ContentFrame.ScrollBarImageColor3 = Color3.fromRGB(60, 60, 80)
    ContentFrame.CanvasSize = UDim2.new(0, 0, 0, 650)
    ContentFrame.Parent = MainFrame

    -- FEATURE TOGGLE SYSTEM
    local FeatureDefinitions = {
        {Name = "PRECISION AIM", Category = "AIMBOT", Field = "ENABLED", Color = Color3.fromRGB(255, 60, 60)},
        {Name = "TEAM FILTER", Category = "AIMBOT", Field = "TEAM_CHECK", Color = Color3.fromRGB(80, 120, 255)},
        {Name = "SPATIAL AWARENESS", Category = "ESP", Field = "ENABLED", Color = Color3.fromRGB(60, 255, 100)},
        {Name = "FRIENDLY FILTER", Category = "ESP", Field = "TEAM_CHECK", Color = Color3.fromRGB(80, 200, 255)},
        {Name = "HITBOX EXPANSION", Category = "HITBOX", Field = "ENABLED", Color = Color3.fromRGB(255, 120, 40)},
        {Name = "AERIAL MOBILITY", Category = "FLY", Field = "ENABLED", Color = Color3.fromRGB(180, 80, 255)}
    }

    for index, feature in ipairs(FeatureDefinitions) do
        local ToggleFrame = Instance.new("Frame")
        ToggleFrame.Size = UDim2.new(1, 0, 0, 50)
        ToggleFrame.Position = UDim2.new(0, 0, 0, (index-1) * 55)
        ToggleFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
        ToggleFrame.BorderSizePixel = 0
        ToggleFrame.Parent = ContentFrame

        local ToggleButton = Instance.new("TextButton")
        ToggleButton.Size = UDim2.new(1, -10, 1, -10)
        ToggleButton.Position = UDim2.new(0, 5, 0, 5)
        ToggleButton.BackgroundColor3 = ShadowConfig[feature.Category][feature.Field] and feature.Color or Color3.fromRGB(40, 40, 55)
        ToggleButton.Text = feature.Name .. "\n" .. (ShadowConfig[feature.Category][feature.Field] and "ACTIVE" : "INACTIVE")
        ToggleButton.TextColor3 = Color3.fromRGB(220, 220, 220)
        ToggleButton.TextSize = 12
        ToggleButton.Font = Enum.Font.Gotham
        ToggleButton.TextWrapped = true
        ToggleButton.Parent = ToggleFrame

        -- SMOOTH TOGGLE ANIMATION
        ToggleButton.MouseButton1Click:Connect(function()
            ShadowConfig[feature.Category][feature.Field] = not ShadowConfig[feature.Category][feature.Field]
            
            local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            local tween = TweenService:Create(ToggleButton, tweenInfo, {
                BackgroundColor3 = ShadowConfig[feature.Category][feature.Field] and feature.Color or Color3.fromRGB(40, 40, 55)
            })
            tween:Play()
            
            ToggleButton.Text = feature.Name .. "\n" .. (ShadowConfig[feature.Category][field] and "ACTIVE" : "INACTIVE")
            
            -- FEATURE-SPECIFIC HANDLERS
            if feature.Category == "FLY" then
                ToggleFlight()
            elseif feature.Category == "ESP" and not ShadowConfig.ESP.ENABLED then
                ClearESPCache()
            end
        end)
    end

    -- CLOSE HANDLER
    CloseButton.MouseButton1Click:Connect(function()
        GUI:Destroy()
        ShadowConfig.ACTIVE = false
    end)

    return GUI
end

-- ENHANCED TARGET ACQUISITION
local function AcquireOptimalTarget()
    if not ShadowConfig.AIMBOT.ENABLED then return nil end
    
    local optimalTarget = nil
    local minimalDistance = ShadowConfig.AIMBOT.FOV
    local viewportCenter = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if not player.Character then continue end
        
        -- TEAM VALIDATION
        if ShadowConfig.AIMBOT.TEAM_CHECK then
            if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
                continue
            end
        end
        
        local rootPart = player.Character:FindFirstChild("HumanoidRootPart")
        local humanoid = player.Character:FindFirstChildOfClass("Humanoid")
        
        if rootPart and humanoid and humanoid.Health > 0 then
            local screenPosition, visible = Camera:WorldToViewportPoint(rootPart.Position)
            
            if visible then
                local screenPoint = Vector2.new(screenPosition.X, screenPosition.Y)
                local distance = (screenPoint - viewportCenter).Magnitude
                
                if distance < minimalDistance then
                    minimalDistance = distance
                    optimalTarget = player
                end
            end
        end
    end
    
    return optimalTarget
end

-- PRECISION AIMING SYSTEM
local function ExecutePrecisionAim()
    if not TARGET or not TARGET.Character then return end
    
    local targetCharacter = TARGET.Character
    local aimPart = targetCharacter:FindFirstChild("Head") or targetCharacter:FindFirstChild("HumanoidRootPart")
    if not aimPart then return end
    
    local currentCFrame = Camera.CFrame
    local targetPosition = aimPart.Position
    
    -- VELOCITY PREDICTION
    local targetVelocity = aimPart.AssemblyLinearVelocity
    local predictedPosition = targetPosition + (targetVelocity * ShadowConfig.AIMBOT.PREDICTION)
    
    local aimDirection = (predictedPosition - currentCFrame.Position).Unit
    local smoothedDirection = currentCFrame.LookVector:Lerp(aimDirection, ShadowConfig.AIMBOT.SMOOTHING)
    
    Camera.CFrame = CFrame.new(currentCFrame.Position, currentCFrame.Position + smoothedDirection)
end

-- OPTIMIZED ESP MANAGEMENT
local function UpdateSpatialAwareness()
    CleanupOrphans()
    
    if not ShadowConfig.ESP.ENABLED then return end
    if tick() - LAST_ESP_UPDATE < ShadowConfig.ESP.UPDATE_INTERVAL then return end
    
    LAST_ESP_UPDATE = tick()
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if not player.Character then continue end
        
        -- DISTANCE CHECK
        local rootPart = player.Character:FindFirstChild("HumanoidRootPart")
        if not rootPart then continue end
        
        local distance = (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")) 
            and (rootPart.Position - LocalPlayer.Character.HumanoidRootPart.Position).Magnitude or 0
        
        if distance > ShadowConfig.ESP.MAX_DISTANCE then
            if ESP_CACHE[player] then
                SafeDestroy(ESP_CACHE[player])
                ESP_CACHE[player] = nil
            end
            continue
        end
        
        -- TEAM VALIDATION
        if ShadowConfig.ESP.TEAM_CHECK then
            if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
                if ESP_CACHE[player] then
                    SafeDestroy(ESP_CACHE[player])
                    ESP_CACHE[player] = nil
                end
                continue
            end
        end
        
        -- CREATE/UPDATE HIGHLIGHT
        if not ESP_CACHE[player] then
            local highlight = Instance.new("Highlight")
            highlight.FillColor = Color3.fromRGB(255, 50, 50)
            highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
            highlight.FillTransparency = 0.8
            highlight.OutlineTransparency = 0.2
            highlight.Adornee = player.Character
            highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
            highlight.Parent = player.Character
            
            ESP_CACHE[player] = highlight
        end
    end
end

local function ClearESPCache()
    for player, highlight in pairs(ESP_CACHE) do
        SafeDestroy(highlight)
    end
    ESP_CACHE = {}
end

-- DYNAMIC HITBOX SYSTEM
local function UpdateHitboxExpansion()
    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if not player.Character then continue end
        
        local head = player.Character:FindFirstChild("Head")
        if not head then continue end
        
        -- REMOVE EXISTING HITBOX
        local existingHitbox = head:FindFirstChild("ShadowHitbox")
        if existingHitbox then
            existingHitbox:Destroy()
        end
        
        -- CREATE NEW HITBOX IF ENABLED
        if ShadowConfig.HITBOX.ENABLED then
            local hitboxPart = Instance.new("Part")
            hitboxPart.Name = "ShadowHitbox"
            hitboxPart.Size = head.Size * ShadowConfig.HITBOX.SIZE
            hitboxPart.Transparency = ShadowConfig.HITBOX.TRANSPARENCY
            hitboxPart.Color = Color3.fromRGB(255, 0, 0)
            hitboxPart.Material = Enum.Material.Neon
            hitboxPart.CanCollide = false
            hitboxPart.Anchored = false
            hitboxPart.Parent = head
            
            local weldConstraint = Instance.new("Weld")
            weldConstraint.Part0 = head
            weldConstraint.Part1 = hitboxPart
            weldConstraint.C0 = CFrame.new()
            weldConstraint.Parent = hitboxPart
        end
    end
end

-- ADVANCED FLIGHT SYSTEM
local function ToggleFlight()
    SafeDestroy(BODYGYRO)
    SafeDestroy(BODYVELOCITY)
    BODYGYRO, BODYVELOCITY = nil, nil
    
    if not ShadowConfig.FLY.ENABLED then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    BODYGYRO = Instance.new("BodyGyro")
    BODYGYRO.P = 1000
    BODYGYRO.D = 50
    BODYGYRO.MaxTorque = Vector3.new(4000, 4000, 4000)
    BODYGYRO.CFrame = rootPart.CFrame
    BODYGYRO.Parent = rootPart
    
    BODYVELOCITY = Instance.new("BodyVelocity")
    BODYVELOCITY.Velocity = Vector3.new(0, 0, 0)
    BODYVELOCITY.MaxForce = Vector3.new(4000, 4000, 4000)
    BODYVELOCITY.Parent = rootPart
end

local function ProcessFlightInput()
    if not ShadowConfig.FLY.ENABLED or not BODYVELOCITY then return end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    local movementVector = Vector3.new(0, 0, 0)
    
    if FLY_CONTROLS.W then movementVector = movementVector + rootPart.CFrame.LookVector end
    if FLY_CONTROLS.S then movementVector = movementVector - rootPart.CFrame.LookVector end
    if FLY_CONTROLS.A then movementVector = movementVector - rootPart.CFrame.RightVector end
    if FLY_CONTROLS.D then movementVector = movementVector + rootPart.CFrame.RightVector end
    if FLY_CONTROLS.Space then movementVector = movementVector + Vector3.new(0, ShadowConfig.FLY.VERTICAL_MULTIPLIER, 0) end
    if FLY_CONTROLS.Shift then movementVector = movementVector + Vector3.new(0, -ShadowConfig.FLY.VERTICAL_MULTIPLIER, 0) end
    
    BODYVELOCITY.Velocity = movementVector * ShadowConfig.FLY.SPEED * 20
end

-- OPTIMIZED CORE LOOP
local HeartbeatConnection = RunService.Heartbeat:Connect(function()
    if not ShadowConfig.ACTIVE then
        HeartbeatConnection:Disconnect()
        return
    end
    
    -- PRECISION AIMING
    if ShadowConfig.AIMBOT.ENABLED and TARGET then
        ExecutePrecisionAim()
    end
    
    -- SPATIAL AWARENESS
    UpdateSpatialAwareness()
    
    -- HITBOX MANAGEMENT
    UpdateHitboxExpansion()
    
    -- AERIAL MOBILITY
    ProcessFlightInput()
end)

-- ENHANCED INPUT HANDLING
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    
    -- AIMBOT ACTIVATION
    if input.UserInputType == Enum.UserInputType.MouseButton1 and ShadowConfig.AIMBOT.ENABLED then
        TARGET = AcquireOptimalTarget()
    end
    
    -- INTERFACE TOGGLE
    if input.KeyCode == Enum.KeyCode.Insert then
        CreateShadowGUI()
    end
    
    -- FLIGHT CONTROLS
    if input.KeyCode == Enum.KeyCode.W then FLY_CONTROLS.W = true end
    if input.KeyCode == Enum.KeyCode.A then FLY_CONTROLS.A = true end
    if input.KeyCode == Enum.KeyCode.S then FLY_CONTROLS.S = true end
    if input.KeyCode == Enum.KeyCode.D then FLY_CONTROLS.D = true end
    if input.KeyCode == Enum.KeyCode.Space then FLY_CONTROLS.Space = true end
    if input.KeyCode == Enum.KeyCode.LeftShift then FLY_CONTROLS.Shift = true end
end)

UserInputService.InputEnded:Connect(function(input, processed)
    if processed then return end
    
    -- AIMBOT DEACTIVATION
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        TARGET = nil
    end
    
    -- FLIGHT CONTROLS
    if input.KeyCode == Enum.KeyCode.W then FLY_CONTROLS.W = false end
    if input.KeyCode == Enum.KeyCode.A then FLY_CONTROLS.A = false end
    if input.KeyCode == Enum.KeyCode.S then FLY_CONTROLS.S = false end
    if input.KeyCode == Enum.KeyCode.D then FLY_CONTROLS.D = false end
    if input.KeyCode == Enum.KeyCode.Space then FLY_CONTROLS.Space = false end
    if input.KeyCode == Enum.KeyCode.LeftShift then FLY_CONTROLS.Shift = false end
end)

-- SECURE INITIALIZATION
local initializationSuccess, initializationError = pcall(function()
    CreateShadowGUI()
    
    print([[
    
    ███████ ██   ██  █████  ██████  ██████   ██████  
    ██      ██   ██ ██   ██ ██   ██ ██   ██ ██    ██ 
    ███████ ███████ ███████ ██   ██ ██   ██ ██    ██ 
         ██ ██   ██ ██   ██ ██   ██ ██   ██ ██    ██ 
    ███████ ██   ██ ██   ██ ██████  ██████   ██████  
                                                      
           SHADOW CORE v2.4.1 - ACTIVE
           STEALTH MODE: ENGAGED
           PERFORMANCE: OPTIMIZED
    
    ]])
end)

if not initializationSuccess then
    warn("SHADOW CORE INITIALIZATION FAILED: " .. tostring(initializationError))
end

-- SECURE CLEANUP PROTOCOL
Players.PlayerRemoving:Connect(function(player)
    if player == LocalPlayer then
        ShadowConfig.ACTIVE = false
        SafeDestroy(BODYGYRO)
        SafeDestroy(BODYVELOCITY)
        ClearESPCache()
        HeartbeatConnection:Disconnect()
    end
end)
