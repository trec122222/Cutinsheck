-- CuTins Heck HUB 2025 - STACK END FIXED
-- FIXED VERSION - NO STACK OVERFLOW

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local Mouse = LocalPlayer:GetMouse()

-- SIMPLIFIED CONFIG TO PREVENT STACK ISSUES
local CuTins = {
    ACTIVE = true,
    VERSION = "CuTins FPS 2025",
    
    AIMBOT = {
        ENABLED = false,
        FOV = 80,
        SMOOTHING = 0.3,
        TEAM_CHECK = true,
        TRIGGERBOT = false
    },
    
    ESP = {
        ENABLED = false,
        TEAM_CHECK = true
    },
    
    WEAPON = {
        NO_RECOIL = false,
        NO_SPREAD = false
    },
    
    MOVEMENT = {
        SPEED = false,
        SPEED_VALUE = 30
    }
}

-- VARIABLES
local TARGET = nil
local ESP_ITEMS = {}
local LAST_UPDATE = 0
local UPDATE_INTERVAL = 0.1 -- Prevent rapid updates

-- ‚úÖ SIMPLE UI CREATION (FIXED STACK)
local function createSimpleUI()
    local SCREEN_GUI = Instance.new("ScreenGui")
    SCREEN_GUI.Name = "CuTinsFPS"
    SCREEN_GUI.Parent = game:GetService("CoreGui")

    -- Main Frame
    local MAIN_FRAME = Instance.new("Frame")
    MAIN_FRAME.Size = UDim2.new(0, 300, 0, 400)
    MAIN_FRAME.Position = UDim2.new(0, 20, 0.5, -200)
    MAIN_FRAME.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    MAIN_FRAME.BorderSizePixel = 2
    MAIN_FRAME.BorderColor3 = Color3.fromRGB(255, 50, 50)
    MAIN_FRAME.Active = true
    MAIN_FRAME.Draggable = true
    MAIN_FRAME.Parent = SCREEN_GUI

    -- Title
    local Title = Instance.new("TextLabel")
    Title.Size = UDim2.new(1, 0, 0, 40)
    Title.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
    Title.Text = "CuTins FPS 2025"
    Title.TextColor3 = Color3.white
    Title.TextSize = 16
    Title.Font = Enum.Font.GothamBold
    Title.Parent = MAIN_FRAME

    -- Close Button
    local CloseBtn = Instance.new("TextButton")
    CloseBtn.Size = UDim2.new(0, 30, 0, 30)
    CloseBtn.Position = UDim2.new(1, -35, 0, 5)
    CloseBtn.BackgroundColor3 = Color3.fromRGB(200, 0, 0)
    CloseBtn.Text = "X"
    CloseBtn.TextColor3 = Color3.white
    CloseBtn.TextSize = 14
    CloseBtn.Font = Enum.Font.GothamBold
    CloseBtn.Parent = MAIN_FRAME

    -- Content
    local Content = Instance.new("ScrollingFrame")
    Content.Size = UDim2.new(1, -20, 1, -60)
    Content.Position = UDim2.new(0, 10, 0, 50)
    Content.BackgroundTransparency = 1
    Content.CanvasSize = UDim2.new(0, 0, 0, 500)
    Content.ScrollBarThickness = 4
    Content.Parent = MAIN_FRAME

    -- Simple Toggle Function (FIXED STACK)
    local function createToggle(name, category, setting, yPos)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(1, 0, 0, 40)
        btn.Position = UDim2.new(0, 0, 0, yPos)
        btn.BackgroundColor3 = CuTins[category][setting] and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(60, 60, 80)
        btn.Text = name .. ": " .. (CuTins[category][setting] and "ON" or "OFF")
        btn.TextColor3 = Color3.white
        btn.TextSize = 14
        btn.Font = Enum.Font.GothamBold
        btn.Parent = Content
        
        -- FIX: Use debounce to prevent stack overflow
        local debounce = false
        btn.MouseButton1Click:Connect(function()
            if debounce then return end
            debounce = true
            
            CuTins[category][setting] = not CuTins[category][setting]
            btn.BackgroundColor3 = CuTins[category][setting] and Color3.fromRGB(0, 150, 0) or Color3.fromRGB(60, 60, 80)
            btn.Text = name .. ": " .. (CuTins[category][setting] and "ON" or "OFF")
            
            -- Reset debounce after delay
            wait(0.1)
            debounce = false
        end)
    end

    -- Create Toggles
    createToggle("üéØ AIMBOT", "AIMBOT", "ENABLED", 0)
    createToggle("üîµ TEAM CHECK", "AIMBOT", "TEAM_CHECK", 45)
    createToggle("üî´ TRIGGERBOT", "AIMBOT", "TRIGGERBOT", 90)
    createToggle("üëÅÔ∏è ESP", "ESP", "ENABLED", 135)
    createToggle("üî´ NO RECOIL", "WEAPON", "NO_RECOIL", 180)
    createToggle("üéØ NO SPREAD", "WEAPON", "NO_SPREAD", 225)
    createToggle("üèÉ SPEED", "MOVEMENT", "SPEED", 270)

    -- Close Event
    CloseBtn.MouseButton1Click:Connect(function()
        SCREEN_GUI:Destroy()
        CuTins.ACTIVE = false
    end)

    return SCREEN_GUI
end

-- ‚úÖ OPTIMIZED GAME FUNCTIONS (FIXED STACK)

local function getClosestPlayer()
    if not CuTins.AIMBOT.ENABLED then return nil end
    
    local closest = nil
    local closestDist = CuTins.AIMBOT.FOV
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            -- Team Check
            if CuTins.AIMBOT.TEAM_CHECK then
                if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
                    continue
                end
            end
            
            local root = player.Character:FindFirstChild("HumanoidRootPart")
            if root then
                local screenPos, onScreen = Camera:WorldToViewportPoint(root.Position)
                if onScreen then
                    local mousePos = UserInputService:GetMouseLocation()
                    local distance = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
                    if distance < closestDist then
                        closestDist = distance
                        closest = player
                    end
                end
            end
        end
    end
    return closest
end

local function aimAtTarget()
    if not TARGET or not TARGET.Character then return end
    
    local targetPart = TARGET.Character:FindFirstChild("Head") or TARGET.Character:FindFirstChild("HumanoidRootPart")
    if not targetPart then return end
    
    local currentCF = Camera.CFrame
    local targetPos = targetPart.Position
    
    -- Simple smoothing with stack protection
    local direction = (targetPos - currentCF.Position).Unit
    local smoothDirection = currentCF.LookVector:Lerp(direction, CuTins.AIMBOT.SMOOTHING)
    Camera.CFrame = CFrame.new(currentCF.Position, currentCF.Position + smoothDirection)
end

-- FIXED: Optimized ESP to prevent stack overflow
local function updateESP()
    -- Use time-based throttling
    local currentTime = tick()
    if currentTime - LAST_UPDATE < UPDATE_INTERVAL then
        return
    end
    LAST_UPDATE = currentTime
    
    -- Cleanup first
    for player, highlight in pairs(ESP_ITEMS) do
        if highlight and highlight.Parent then
            highlight:Destroy()
        end
    end
    ESP_ITEMS = {}
    
    if not CuTins.ESP.ENABLED then return end
    
    -- Create ESP for enemies only
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            -- Team Check
            if CuTins.ESP.TEAM_CHECK then
                if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
                    continue
                end
            end
            
            local highlight = Instance.new("Highlight")
            highlight.FillColor = Color3.fromRGB(255, 50, 50)
            highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
            highlight.FillTransparency = 0.8
            highlight.Adornee = player.Character
            highlight.Parent = player.Character
            
            ESP_ITEMS[player] = highlight
        end
    end
end

-- FIXED: Weapon modifications with stack protection
local function setupWeaponHooks()
    if not (CuTins.WEAPON.NO_RECOIL or CuTins.WEAPON.NO_SPREAD) then
        return
    end
    
    -- Use pcall to prevent stack errors
    local success, error = pcall(function()
        local mt = getrawmetatable(game)
        if not mt then return end
        
        local oldIndex = mt.__index
        setreadonly(mt, false)
        
        mt.__index = newcclosure(function(t, k)
            if not checkcaller() then
                if CuTins.WEAPON.NO_RECOIL and string.lower(tostring(k)):find("recoil") then
                    return 0
                end
                if CuTins.WEAPON.NO_SPREAD and string.lower(tostring(k)):find("spread") then
                    return 0
                end
            end
            return oldIndex(t, k)
        end)
        
        setreadonly(mt, true)
    end)
    
    if not success then
        warn("Weapon hooks failed: " .. tostring(error))
    end
end

-- FIXED: Triggerbot with stack protection
local function triggerBot()
    if not CuTins.AIMBOT.TRIGGERBOT or not CuTins.AIMBOT.ENABLED then 
        return 
    end
    
    local target = getClosestPlayer()
    if target and target.Character then
        -- Use coroutine to prevent stack buildup
        coroutine.wrap(function()
            wait(0.1)
            pcall(mouse1click)
        end)()
    end
end

-- ‚úÖ OPTIMIZED MAIN LOOP (FIXED STACK)
local lastHeartbeat = 0
local heartbeatInterval = 0.03 -- ~30 FPS

RunService.Heartbeat:Connect(function()
    -- Throttle updates to prevent stack overflow
    local currentTime = tick()
    if currentTime - lastHeartbeat < heartbeatInterval then
        return
    end
    lastHeartbeat = currentTime
    
    -- Aimbot
    if CuTins.AIMBOT.ENABLED and TARGET then
        pcall(aimAtTarget)
    end
    
    -- ESP (throttled)
    if currentTime - LAST_UPDATE >= UPDATE_INTERVAL then
        pcall(updateESP)
    end
    
    -- Movement
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") then
        local humanoid = LocalPlayer.Character.Humanoid
        humanoid.WalkSpeed = CuTins.MOVEMENT.SPEED and CuTins.MOVEMENT.SPEED_VALUE or 16
    end
    
    -- Triggerbot
    pcall(triggerBot)
end)

-- ‚úÖ INPUT HANDLING (FIXED STACK)
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    
    -- Use pcall to prevent stack errors
    pcall(function()
        -- Aimbot with left click
        if input.UserInputType == Enum.UserInputType.MouseButton1 and CuTins.AIMBOT.ENABLED then
            TARGET = getClosestPlayer()
        end
    end)
end)

UserInputService.InputEnded:Connect(function(input, processed)
    if processed then return end
    
    pcall(function()
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            TARGET = nil
        end
    end)
end)

-- ‚úÖ SAFE INITIALIZATION
local success, error = pcall(function()
    local UI = createSimpleUI()
    setupWeaponHooks()
    
    print([[

 ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
‚ñà‚ñà      ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà
‚ñà‚ñà      ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà  ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
‚ñà‚ñà      ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà  ‚ñà‚ñà ‚ñà‚ñà      ‚ñà‚ñà
 ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà     ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
                                                 
        CuTins Heck - CuTins ¬© 2025

‚úÖ CU TINS FPS ƒê√É K√çCH HO·∫†T AN TO√ÄN!

]])

end)

if not success then
    warn("Initialization failed: " .. tostring(error))
end

-- ‚úÖ SAFE CLEANUP
game:GetService("Players").PlayerRemoving:Connect(function(player)
    if player == LocalPlayer then
        CuTins.ACTIVE = false
        for _, highlight in pairs(ESP_ITEMS) do
            if highlight then
                pcall(function() highlight:Destroy() end)
            end
        end
    end
end)

-- ‚úÖ SAFE MAIN LOOP
while CuTins.ACTIVE do
    wait(1) -- Safe wait to prevent stack
end
