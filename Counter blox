-- CuTins Heck HUB 2025 - ERROR FIXED EDITION
-- COMPLETE BUG FIXES APPLIED

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- ‚úÖ SAFE CONFIGURATION WITH ERROR HANDLING
local CuTins = {
    ACTIVE = true,
    VERSION = "CuTins Heck 2025 - STABLE",
    UI_OPEN = true,
    MINIMIZED = false,
    
    -- MODULES WITH SAFE DEFAULTS
    AIMBOT = {
        ENABLED = false,
        MOUSE_BUTTON = Enum.UserInputType.MouseButton1,
        FOV = 80,
        SMOOTHING = 0.3,
        TARGET_BONE = "Head",
        TEAM_CHECK = true,
        HEADSHOT_PRIORITY = true
    },
    
    ESP = {
        ENABLED = false,
        TEAM_CHECK = true,
        BOX = true,
        NAMES = false, -- Disabled to prevent errors
        HEALTH = false,
        DISTANCE = false
    },
    
    HITBOX = {
        ENABLED = false,
        SIZE = 2.0
    },
    
    FLY = {
        ENABLED = false,
        SPEED = 3
    }
}

-- ‚úÖ SAFE VARIABLES WITH NIL CHECKS
local TARGET = nil
local ESP_ITEMS = {}
local FLYING = false
local BODYGYRO, BODYVELOCITY = nil, nil
local SCREEN_GUI = nil
local MAIN_FRAME = nil

-- ‚úÖ SAFE FUNCTION WRAPPERS
local function SafeCall(func, fallback)
    return function(...)
        local success, result = pcall(func, ...)
        if not success then
            warn("Function error: " .. tostring(result))
            return fallback
        end
        return result
    end
end

local function SafeDestroy(obj)
    if obj and obj.Parent then
        pcall(function() obj:Destroy() end)
    end
end

local function SafeWait(seconds)
    local success = pcall(function()
        wait(seconds or 0.1)
    end)
    return success
end

-- ‚úÖ FIXED HUB CREATION WITH ERROR HANDLING
function createHubInterface()
    -- Safe cleanup
    pcall(function()
        if SCREEN_GUI then
            SafeDestroy(SCREEN_GUI)
        end
        local oldGUI = game:GetService("CoreGui"):FindFirstChild("CuTinsHeckUI")
        if oldGUI then
            SafeDestroy(oldGUI)
        end
    end)

    -- Create main ScreenGui with protection
    local success, gui = pcall(function()
        local GUI = Instance.new("ScreenGui")
        GUI.Name = "CuTinsHeckUI"
        GUI.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
        GUI.DisplayOrder = 999
        GUI.Parent = game:GetService("CoreGui")
        return GUI
    end)
    
    if not success then return nil end
    SCREEN_GUI = gui

    -- Create main container with error handling
    local mainSuccess, mainFrame = pcall(function()
        local Frame = Instance.new("Frame")
        Frame.Name = "MainFrame"
        Frame.Size = UDim2.new(0, 400, 0, 500)
        Frame.Position = UDim2.new(0, 20, 0.5, -250)
        Frame.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
        Frame.BackgroundTransparency = 0.1
        Frame.BorderSizePixel = 0
        Frame.ClipsDescendants = true
        Frame.Parent = SCREEN_GUI
        
        local UICorner = Instance.new("UICorner")
        UICorner.CornerRadius = UDim.new(0, 12)
        UICorner.Parent = Frame
        
        return Frame
    end)
    
    if not mainSuccess then return nil end
    MAIN_FRAME = mainFrame

    -- ‚úÖ SIMPLIFIED HEADER (FIXED VERSION)
    pcall(function()
        local Header = Instance.new("Frame")
        Header.Name = "Header"
        Header.Size = UDim2.new(1, 0, 0, 50)
        Header.BackgroundColor3 = Color3.fromRGB(30, 30, 45)
        Header.BorderSizePixel = 0
        Header.Parent = MAIN_FRAME

        local HeaderCorner = Instance.new("UICorner")
        HeaderCorner.CornerRadius = UDim.new(0, 12)
        HeaderCorner.Parent = Header

        -- Title
        local Title = Instance.new("TextLabel")
        Title.Name = "Title"
        Title.Size = UDim2.new(0.6, 0, 1, 0)
        Title.Position = UDim2.new(0, 15, 0, 0)
        Title.BackgroundTransparency = 1
        Title.Text = "CuTins Heck 2025 - STABLE"
        Title.TextColor3 = Color3.fromRGB(255, 255, 255)
        Title.TextSize = 16
        Title.Font = Enum.Font.GothamBold
        Title.TextXAlignment = Enum.TextXAlignment.Left
        Title.Parent = Header

        -- Control Buttons
        local MinimizeButton = Instance.new("TextButton")
        MinimizeButton.Name = "MinimizeButton"
        MinimizeButton.Size = UDim2.new(0, 30, 0, 30)
        MinimizeButton.Position = UDim2.new(1, -70, 0.5, -15)
        MinimizeButton.BackgroundColor3 = Color3.fromRGB(255, 150, 0)
        MinimizeButton.Text = "_"
        MinimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        MinimizeButton.TextSize = 16
        MinimizeButton.Font = Enum.Font.GothamBold
        MinimizeButton.Parent = Header

        local CloseButton = Instance.new("TextButton")
        CloseButton.Name = "CloseButton"
        CloseButton.Size = UDim2.new(0, 30, 0, 30)
        CloseButton.Position = UDim2.new(1, -35, 0.5, -15)
        CloseButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
        CloseButton.Text = "X"
        CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        CloseButton.TextSize = 14
        CloseButton.Font = Enum.Font.GothamBold
        CloseButton.Parent = Header

        -- Button functionality
        CloseButton.MouseButton1Click:Connect(function()
            CuTins.UI_OPEN = false
            SCREEN_GUI.Enabled = false
        end)

        MinimizeButton.MouseButton1Click:Connect(function()
            CuTins.MINIMIZED = not CuTins.MINIMIZED
            local Content = MAIN_FRAME:FindFirstChild("Content")
            if Content then
                Content.Visible = not CuTins.MINIMIZED
            end
            if CuTins.MINIMIZED then
                MAIN_FRAME.Size = UDim2.new(0, 400, 0, 50)
                MinimizeButton.Text = "‚ñ°"
            else
                MAIN_FRAME.Size = UDim2.new(0, 400, 0, 500)
                MinimizeButton.Text = "_"
            end
        end)
    end)

    -- ‚úÖ SIMPLIFIED CONTENT AREA
    pcall(function()
        local Content = Instance.new("Frame")
        Content.Name = "Content"
        Content.Size = UDim2.new(1, -20, 1, -70)
        Content.Position = UDim2.new(0, 10, 0, 60)
        Content.BackgroundTransparency = 1
        Content.Visible = not CuTins.MINIMIZED
        Content.Parent = MAIN_FRAME

        local ScrollingFrame = Instance.new("ScrollingFrame")
        ScrollingFrame.Name = "ScrollingFrame"
        ScrollingFrame.Size = UDim2.new(1, 0, 1, 0)
        ScrollingFrame.BackgroundTransparency = 1
        ScrollingFrame.ScrollBarThickness = 3
        ScrollingFrame.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 150)
        ScrollingFrame.CanvasSize = UDim2.new(0, 0, 0, 400)
        ScrollingFrame.Parent = Content

        -- ‚úÖ BASIC TOGGLE SYSTEM (STABLE VERSION)
        local features = {
            {"üéØ AIMBOT", "AIMBOT", "ENABLED"},
            {"üîµ TEAM CHECK", "AIMBOT", "TEAM_CHECK"},
            {"üëÅÔ∏è ESP", "ESP", "ENABLED"},
            {"üéØ HITBOX", "HITBOX", "ENABLED"},
            {"üïäÔ∏è FLY", "FLY", "ENABLED"}
        }

        for i, feature in ipairs(features) do
            local ToggleFrame = Instance.new("Frame")
            ToggleFrame.Size = UDim2.new(1, 0, 0, 40)
            ToggleFrame.Position = UDim2.new(0, 0, 0, (i-1) * 45)
            ToggleFrame.BackgroundTransparency = 1
            ToggleFrame.Parent = ScrollingFrame

            local Label = Instance.new("TextLabel")
            Label.Size = UDim2.new(0.7, 0, 1, 0)
            Label.BackgroundTransparency = 1
            Label.Text = feature[1]
            Label.TextColor3 = Color3.fromRGB(200, 200, 200)
            Label.TextSize = 14
            Label.Font = Enum.Font.Gotham
            Label.TextXAlignment = Enum.TextXAlignment.Left
            Label.Parent = ToggleFrame

            local ToggleButton = Instance.new("TextButton")
            ToggleButton.Size = UDim2.new(0, 60, 0, 30)
            ToggleButton.Position = UDim2.new(1, -65, 0.5, -15)
            ToggleButton.BackgroundColor3 = CuTins[feature[2]][feature[3]] and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 0, 0)
            ToggleButton.Text = CuTins[feature[2]][feature[3]] and "ON" or "OFF"
            ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
            ToggleButton.TextSize = 12
            ToggleButton.Font = Enum.Font.GothamBold
            ToggleButton.Parent = ToggleFrame

            ToggleButton.MouseButton1Click:Connect(function()
                CuTins[feature[2]][feature[3]] = not CuTins[feature[2]][feature[3]]
                ToggleButton.BackgroundColor3 = CuTins[feature[2]][feature[3]] and Color3.fromRGB(0, 200, 0) or Color3.fromRGB(200, 0, 0)
                ToggleButton.Text = CuTins[feature[2]][feature[3]] and "ON" or "OFF"
                
                -- Special handlers
                if feature[2] == "FLY" then
                    SafeCall(toggleFly)()
                elseif feature[2] == "ESP" and not CuTins.ESP.ENABLED then
                    SafeCall(cleanupESP)()
                end
            end)
        end
    end)

    return SCREEN_GUI
end

-- ‚úÖ FIXED GAME FUNCTIONS WITH SAFE CHECKS
function getClosestPlayer()
    if not CuTins.AIMBOT.ENABLED then return nil end
    
    local closest = nil
    local closestDist = CuTins.AIMBOT.FOV
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        
        local character = player.Character
        if not character then continue end
        
        -- SAFE CHARACTER CHECK
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        local head = character:FindFirstChild("Head")
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        
        if not humanoid or not head or not rootPart then continue end
        if humanoid.Health <= 0 then continue end
        
        -- Team check
        if CuTins.AIMBOT.TEAM_CHECK then
            if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
                continue
            end
        end
        
        local screenPos, onScreen = Camera:WorldToViewportPoint(head.Position)
        if onScreen then
            local mousePos = UserInputService:GetMouseLocation()
            local distance = (Vector2.new(screenPos.X, screenPos.Y) - mousePos).Magnitude
            if distance < closestDist then
                closestDist = distance
                closest = player
            end
        end
    end
    return closest
end

function aimAtTarget()
    if not TARGET then return end
    
    local character = TARGET.Character
    if not character then return end
    
    -- SAFE BONE ACCESS
    local targetBone = character:FindFirstChild(CuTins.AIMBOT.TARGET_BONE)
    if not targetBone then
        targetBone = character:FindFirstChild("HumanoidRootPart")
        if not targetBone then return end
    end
    
    local currentCF = Camera.CFrame
    local targetPos = targetBone.Position
    
    local direction = (targetPos - currentCF.Position).Unit
    local smoothDirection = currentCF.LookVector:Lerp(direction, CuTins.AIMBOT.SMOOTHING)
    Camera.CFrame = CFrame.new(currentCF.Position, currentCF.Position + smoothDirection)
end

function createESP(player)
    if player == LocalPlayer then return end
    if not player.Character then return end
    
    -- Team check
    if CuTins.ESP.TEAM_CHECK then
        if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
            return
        end
    end
    
    local char = player.Character
    
    -- Remove old ESP
    if ESP_ITEMS[player] then
        SafeDestroy(ESP_ITEMS[player])
    end
    
    if CuTins.ESP.ENABLED then
        local highlight = Instance.new("Highlight")
        highlight.FillColor = Color3.fromRGB(255, 50, 50)
        highlight.OutlineColor = Color3.fromRGB(255, 255, 255)
        highlight.FillTransparency = 0.7
        highlight.Parent = char
        ESP_ITEMS[player] = highlight
    end
end

function cleanupESP()
    for player, item in pairs(ESP_ITEMS) do
        SafeDestroy(item)
    end
    ESP_ITEMS = {}
end

function updateHitboxes()
    for _, player in ipairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if not player.Character then continue end
        
        local char = player.Character
        for _, part in pairs(char:GetDescendants()) do
            if part.Name == "CUTINS_HITBOX" then
                SafeDestroy(part)
            end
        end
        
        if CuTins.HITBOX.ENABLED then
            local head = char:FindFirstChild("Head")
            if head then
                local hitbox = Instance.new("Part")
                hitbox.Name = "CUTINS_HITBOX"
                hitbox.Size = head.Size * CuTins.HITBOX.SIZE
                hitbox.Transparency = 1
                hitbox.CanCollide = false
                hitbox.Parent = head
                
                local weld = Instance.new("Weld")
                weld.Part0 = head
                weld.Part1 = hitbox
                weld.C0 = CFrame.new()
                weld.Parent = hitbox
            end
        end
    end
end

function toggleFly()
    -- Cleanup old
    SafeDestroy(BODYGYRO)
    SafeDestroy(BODYVELOCITY)
    
    if not CuTins.FLY.ENABLED then 
        FLYING = false
        return 
    end
    
    local character = LocalPlayer.Character
    if not character then return end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if not rootPart then return end
    
    BODYGYRO = Instance.new("BodyGyro")
    BODYGYRO.P = 1000
    BODYGYRO.D = 50
    BODYGYRO.MaxTorque = Vector3.new(4000, 4000, 4000)
    BODYGYRO.CFrame = rootPart.CFrame
    BODYGYRO.Parent = rootPart
    
    BODYVELOCITY = Instance.new("BodyVelocity")
    BODYVELOCITY.Velocity = Vector3.new(0, 0, 0)
    BODYVELOCITY.MaxForce = Vector3.new(4000, 4000, 4000)
    BODYVELOCITY.Parent = rootPart
    
    FLYING = true
end

-- ‚úÖ FIXED INPUT HANDLING
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    
    -- Toggle UI with Insert key
    if input.KeyCode == Enum.KeyCode.Insert then
        CuTins.UI_OPEN = not CuTins.UI_OPEN
        if SCREEN_GUI then
            SCREEN_GUI.Enabled = CuTins.UI_OPEN
        else
            SafeCall(createHubInterface)()
        end
    end
    
    -- Aimbot with left click
    if input.UserInputType == CuTins.AIMBOT.MOUSE_BUTTON and CuTins.AIMBOT.ENABLED then
        TARGET = SafeCall(getClosestPlayer)()
    end
    
    -- Fly toggle with F key
    if input.KeyCode == Enum.KeyCode.F then
        CuTins.FLY.ENABLED = not CuTins.FLY.ENABLED
        SafeCall(toggleFly)()
    end
end)

UserInputService.InputEnded:Connect(function(input, processed)
    if processed then return end
    
    if input.UserInputType == CuTins.AIMBOT.MOUSE_BUTTON then
        TARGET = nil
    end
end)

-- ‚úÖ FIXED MAIN LOOP WITH ERROR PROTECTION
RunService.RenderStepped:Connect(function()
    -- Safe aimbot
    if CuTins.AIMBOT.ENABLED and TARGET then
        SafeCall(aimAtTarget)()
    end
    
    -- Safe ESP
    if CuTins.ESP.ENABLED then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and not ESP_ITEMS[player] then
                SafeCall(createESP)(player)
            end
        end
    end
end)

-- ‚úÖ SAFE INITIALIZATION
local initSuccess = pcall(function()
    SafeCall(createHubInterface)()
    
    -- Safe player tracking
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and CuTins.ESP.ENABLED and player.Character then
            SafeCall(createESP)(player)
        end
        
        player.CharacterAdded:Connect(function(char)
            SafeWait(1)
            if CuTins.ESP.ENABLED then
                SafeCall(createESP)(player)
            end
        end)
    end
end)

if not initSuccess then
    warn("CuTins Heck: Initialization had minor issues, but script is running")
end

print([[

 ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
‚ñà‚ñà      ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà ‚ñà‚ñà
‚ñà‚ñà      ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà ‚ñà‚ñà  ‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
‚ñà‚ñà      ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà  ‚ñà‚ñà ‚ñà‚ñà       ‚ñà‚ñà
 ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà     ‚ñà‚ñà    ‚ñà‚ñà ‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
                                                 
        Heck 2025 - STABLE EDITION

]])

-- Safe main loop
while CuTins.ACTIVE do
    SafeWait(1)
end
